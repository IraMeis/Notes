# Автоматическое распараллеливание ациклических фрагментов последовательных программ (построение ЯПФ и параллельного алгоритма)

## Ярусно-параллельная форма

Построение ярусно-параллельной формы (ЯПФ) программы начинается с помещения в первый ее ярус вершин графа зависимостей, которые не зависят ни от какой другой вершины этого графа. Каждый следующий ярус образуется из вершин, зависящих исключительно от вершин предыдущих ярусов. С исчерпанием вершин графа зависимостей построение ярусно-параллельной формы считается завершенным. 

Разрабатывая методы автоматического распараллеливания необходимо алгоритмизировать и предельно формализовать все предписания, как предназначенные для исполнения на вычислительной системе. 

Тогда процедура построения ЯПФ может быть представлена в следующем виде.
1. В первый ярус ЯПФ помещаются вершины A такие, что $\forall A' \neg dep(A', A)$. При записи ЯПФ общего вида они будут дополнительно маркированы парой индексов $A_{1,1}; A_{1,2}; A_{1,3}; \dots; A_{1,n}$, где первый - номер яруса, второй - номер в ярусе. Пусть первый ярус будет составлен из $n_{1}$ вершин.
2. Положим, что $k$ ярусов уже построены. Если $\forall A$ из графа зависимостей  $\exists i\leq k \land \exists j \leq n_{i} : A=A_{i,j}$ (все вершины распределены по ярусам), то построение ЯПФ завершено. Иначе переходим на шаг 3.
3. Ярус $k+1$ заполняется вершинами $A$ такими, что для $\forall A$ из $dep(A', A)$ следует, что $\exists i \leq k \land \exists j \leq n_{i} : A_{i,j}=A'$ (A зависит только от вершин предыдущих ярусов). Увеличиваем счетчик ярусов $k$ на единицу, переходим на шаг 2.

По окончанию заполнения ЯПФ примет вид, представленный в табл. 2.1.
![[Pasted image 20220612162143.png]]
Обращаясь к примеру графа зависимостей на рис. 2.1 б для Программы 2.1 поместим соответствующую им ЯПФ в табл. 2.2. 

Важной особенностью ЯПФ является независимость вершин одного яруса в силу требования их зависимости исключительно от вершин предыдущих ярусов (шаг 3). Значит операторы программы, относящиеся к разным вершинам одного яруса, можно исполнять независимо друг от друга – параллельно. В ЯПФ на рис. 2.1 б одновременно можно исполнять операторы, связанные с вершинами B и C (второй ярус), затем D, E и F (третий ярус). Указанное обстоятельство служит основой для построения параллельного алгоритма по ЯПФ.

## Параллельный алгоритм
Известно множество способов синтеза параллельных алгоритмов и программ по составленной ЯПФ, здесь же представим наиболее простой. 

Пусть заранее известно число задач параллельного алгоритма $p$. Необходимо распределить вершины ЯПФ по задачам, оговорив для каждой последовательность исполнения операторов, с этими вершинами связанных, и коммуникации между задачами.

Процедура синтеза параллельного алгоритма может быть представлена в следующем виде.
1. К задаче $\mu$ параллельного алгоритма $(1\leq \mu \leq p)$ отнесём следующие вершины первого яруса: $A_{1, \mu}; A_{1, \mu+p}; A(1, \mu+2p); \dots; A_{1, \mu+rp}$, где $r$ - натуральное число и вершины $A_{1, \mu+(r+1)p}$ не существует ($\mu+rp\leq n_{1} < \mu+(r+1)p$ - т.е. ярус для задачи $\mu$ исчерпан). Читатель уже знаком с таким способом распределения данных по задачам, именуемым в пункте 1.2.2. циклическим.
2. Положим, что $q$ ярусов ЯПФ уже распределены между задачами. Если $q=k$ (все ярусы исчерпаны), то параллельный алгоритм считаем построенным, иначе переходим на шаг 3.
3. К задаче $\mu$ параллельного алгоритма отнесём следующие вершины яруса $q$, расположив их после вершин предыдущего яруса в последовательности: $c(A_{q, \mu}); A_{q, \mu}; c(A_{q, \mu+p}); A_{q, \mu+p}; c(A_{q, \mu+2p}); A_{q, \mu+2p}; \dots; c(A_{q, \mu+rp}); A_{q, \mu+rp}$, где $\mu+rp\leq n_{q} < \mu+(r+1)p$. Каждой вершине A в этом списке, в отличие от шага 1, предшествует функция $c(A)$, Увеличиваем счётчик $q$ на единицу, переходим на шаг 2.

Таким образом к каждой задаче относят вершины определенного яруса ЯПФ с шагом $p$, перебирая ярусы до их исчерпания. Произвольность расположения вершин на одном ярусе задает вариативность их распределения по задачам и возможность «пересборки» параллельного алгоритма. Кроме того, применение сформулированной процедуры распределения при большом количестве задач и малом числе вершин на некоторых ярусах обусловит несбалансированность алгоритма, когда задачам с меньшими номерами достанется большее количество вершин. В такой ситуации уместней не модифицировать правило распределения вершин по ярусам, а уменьшить число задач.



